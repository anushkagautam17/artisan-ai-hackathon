from fastapi import FastAPI, File, UploadFile, Form
from fastapi.middleware.cors import CORSMiddleware
from PIL import Image
import io
import json
from typing import Dict
import os

app = FastAPI(title="Artisan Marketplace API", version="1.0.0")

# Enable CORS for frontend-backend communication
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # For development only, restrict in production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Helper function to resize image
def resize_image(image_data: bytes, max_size: tuple = (512, 512)) -> bytes:
    """Resize image to reduce file size before processing"""
    image = Image.open(io.BytesIO(image_data))
    image.thumbnail(max_size, Image.Resampling.LANCZOS)
    
    # Convert to JPEG to reduce size
    img_byte_arr = io.BytesIO()
    image.save(img_byte_arr, format='JPEG')
    return img_byte_arr.getvalue()

# Stub AI function (to be replaced with real AI later)
def generate_listing_stub(image_data: bytes, description: str) -> Dict:
    """Stub function that returns fake AI results"""
    return {
        "listing": "Handcrafted Ceramic Vase - Beautiful artisan piece",
        "caption": "This beautiful handcrafted ceramic vase features intricate patterns and is made by skilled local artisans using traditional techniques.",
        "translations": {
            "hi": "हस्तनिर्मित सिरेमिक फूलदान - सुंदर कारीगर टुकड़ा",
            "bn": "হস্তনির্মিত সিরামিক ফুলদানি - সুন্দর কারিগর টুকরা"
        }
    }

@app.get("/")
async def root():
    return {"message": "Artisan Marketplace API is running"}

@app.post("/generate")
async def generate_listing(
    image: UploadFile = File(...),
    description: str = Form(...)
):
    # Read and resize the image
    image_data = await image.read()
    resized_image = resize_image(image_data)
    
    # Generate stub response (will be replaced with real AI in future)
    result = generate_listing_stub(resized_image, description)
    
    return result

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)